---
phase: 03-cli-interface-and-error-handling
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - pkg/cli/run.go
  - pkg/cli/progress.go
  - cmd/mkv-sub-extractor/main.go
autonomous: false
requirements:
  - CLI-05

must_haves:
  truths:
    - "Running with no arguments in a directory with MKV files presents interactive file picker then track selector and produces ASS output"
    - "Running with a file path and --track extracts specified tracks non-interactively with no prompts"
    - "Output files default to MKV directory with auto-generated names; --output overrides the directory"
    - "Multi-track extraction continues on failure, reports all failures at the end"
    - "Progress bar shows during extraction (suppressed by --quiet)"
    - "Completion summary shows extracted file paths, track info, and counts"
    - "Each distinct error case (non-MKV, not found, no subtitles, image track) produces a structured error with correct exit code"
  artifacts:
    - path: "pkg/cli/run.go"
      provides: "Run() function with two-mode dispatch (interactive vs scriptable), extraction loop, completion summary"
      contains: "func Run"
    - path: "pkg/cli/progress.go"
      provides: "Progress bar wrapper and TrackResult type for continue-on-failure extraction"
      contains: "TrackResult"
    - path: "cmd/mkv-sub-extractor/main.go"
      provides: "Minimal entry point calling cli.Run() with os.Exit"
      contains: "cli.Run"
  key_links:
    - from: "pkg/cli/run.go"
      to: "pkg/cli/flags.go"
      via: "ParseFlags and ValidateConfig calls"
      pattern: "ParseFlags|ValidateConfig"
    - from: "pkg/cli/run.go"
      to: "pkg/cli/interactive.go"
      via: "PickMKVFile and SelectTracks calls in interactive mode"
      pattern: "PickMKVFile|SelectTracks"
    - from: "pkg/cli/run.go"
      to: "pkg/cli/errors.go"
      via: "CLIError returns and Format() calls for error display"
      pattern: "CLIError|Format\\(\\)"
    - from: "pkg/cli/run.go"
      to: "pkg/extract"
      via: "ExtractTrackToASS called per-track in extraction loop"
      pattern: "extract\\.ExtractTrackToASS"
    - from: "pkg/cli/run.go"
      to: "pkg/mkvinfo"
      via: "GetMKVInfo for MKV parsing before track selection/extraction"
      pattern: "mkvinfo\\.GetMKVInfo"
    - from: "cmd/mkv-sub-extractor/main.go"
      to: "pkg/cli/run.go"
      via: "main() calls cli.Run() and exits with returned code"
      pattern: "cli\\.Run"
---

<objective>
Wire everything together: create the main orchestration (two-mode dispatch, extraction loop with continue-on-failure, progress bar, completion summary) and update the CLI entry point. Then verify the complete tool works end-to-end.

Purpose: Transform the individual building blocks from Plan 03-01 (errors, flags, interactive) into a working CLI that handles both interactive and scriptable modes. This is the final integration step that makes the tool usable.

Output: pkg/cli/run.go, pkg/cli/progress.go, and a rewritten cmd/mkv-sub-extractor/main.go. Human verification with real MKV files.
</objective>

<execution_context>
@C:/Users/SOUL/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/SOUL/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-interface-and-error-handling/03-RESEARCH.md
@.planning/phases/03-cli-interface-and-error-handling/03-CONTEXT.md
@.planning/phases/03-cli-interface-and-error-handling/03-01-SUMMARY.md
@pkg/cli/errors.go
@pkg/cli/flags.go
@pkg/cli/interactive.go
@pkg/extract/pipeline.go
@pkg/mkvinfo/mkvinfo.go
@pkg/mkvinfo/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create orchestration layer, progress bar, and main entry point</name>
  <files>pkg/cli/run.go, pkg/cli/progress.go, cmd/mkv-sub-extractor/main.go</files>
  <action>
**Create `pkg/cli/progress.go`:**

Define `TrackResult` struct:
```go
type TrackResult struct {
    Track      mkvinfo.SubtitleTrack
    OutputPath string
    Error      error
}
```

Define `ExtractWithProgress(mkvPath string, tracks []mkvinfo.SubtitleTrack, outputDir string, quiet bool) []TrackResult`:
- Creates a `[]TrackResult` of len(tracks)
- If not quiet: create a progress bar using `progressbar.Default(int64(len(tracks)), "Extracting")` from schollz/progressbar/v3
- Loop over tracks: call `extract.ExtractTrackToASS(mkvPath, track, outputDir)` for each track individually (NOT ExtractTracksToASS — we need continue-on-failure behavior per user decision)
- Store result (path or error) in TrackResult
- If not quiet: advance progress bar by 1 after each track
- If not quiet: call bar.Finish() after loop
- Return all results
- IMPORTANT: The existing ExtractTrackToASS creates its own existingPaths map internally. For batch collision handling, create a wrapper that calls the internal pipeline directly OR call ExtractTrackToASS per track (acceptable since each call creates its own collision map — collisions between tracks of the same extraction batch are rare and handled by filesystem-level uniqueness). The simpler approach is fine for Phase 3.

**Create `pkg/cli/run.go`:**

Define `func Run() int` — the main entry point that returns an exit code.

**Flow:**

1. Parse flags: `cfg := ParseFlags()`
2. Validate: `if err := ValidateConfig(cfg); err != nil` -> print `err.Format()` to stderr, return `err.ExitCode`
3. Determine mode:
   - If `cfg.TrackNumbers` is non-empty (--track provided) -> `runScriptable(cfg)`
   - Else -> `runInteractive(cfg)`

**`runInteractive(cfg Config) int`:**

1. **Resolve MKV file:**
   - If `cfg.MKVPath != ""`: use it directly (already validated)
   - If `cfg.MKVPath == ""`: call `PickMKVFile()`. On error: if CLIError, format and return exit code; otherwise print generic error, return 1
2. **Parse MKV info:** `result, err := mkvinfo.GetMKVInfo(mkvPath)`
   - On error: return `ErrCannotReadFile` formatted, exit code 2
3. **Check for subtitle tracks:**
   - If `result.Info.SubtitleCount == 0`: return `ErrNoSubtitleTracks` formatted, exit code 3
4. **Display file info:** Print `mkvinfo.FormatTrackListing(*result)` (shows file header + all tracks)
5. **Track selection:** Call `SelectTracks(result.Tracks)`
   - On error: if CLIError, format and return; if user cancelled (huh returns ErrUserAborted), print "Cancelled." and return 0
6. **Extract:** Call `ExtractWithProgress(mkvPath, selectedTracks, cfg.OutputDir, cfg.Quiet)`
7. **Print completion summary** (see below)
8. **Return exit code:** 0 if all succeeded, 4 if partial failure

**`runScriptable(cfg Config) int`:**

1. **MKV path required:** If `cfg.MKVPath == ""`: return `ErrFileNotFound` (must provide file in scriptable mode), exit code 2
2. **Parse MKV info:** `result, err := mkvinfo.GetMKVInfo(cfg.MKVPath)`
   - On error: structured error, exit code 2
3. **Resolve tracks by number:** For each number in cfg.TrackNumbers, find matching track in result.Tracks by Index. If not found: accumulate `ErrTrackNotFound` errors. If a found track is not extractable (image-based): accumulate `ErrImageTrackSelected` errors.
   - After validation: if ANY track number is invalid, print all errors and return exit code 3
4. **If --verbose:** Print file info header and selected track details
5. **Extract:** Call `ExtractWithProgress(cfg.MKVPath, resolvedTracks, cfg.OutputDir, cfg.Quiet)`
6. **If --quiet:** Only print output file paths (one per line on stdout), nothing else
7. **Otherwise:** Print completion summary
8. **Return exit code:** 0 if all succeeded, 4 if partial failure

**Completion summary (Claude's Discretion):**

Print a summary using lipgloss styled output:
```
Extraction complete!

  Track [1] English (ASS)   -> video.eng.ass (1,247 events)
  Track [3] 中文 (SRT)       -> video.chi.ass (892 events)

  2 tracks extracted successfully
```

If some tracks failed:
```
Extraction complete with errors.

  Track [1] English (ASS)   -> video.eng.ass (1,247 events)
  Track [3] 中文 (SRT)       -> FAILED: write ASS output: disk full

  1 of 2 tracks extracted successfully
```

Use lipgloss green for success indicators, red for failure. Include event count if available (count events from the output file is overkill — just report success/failure + path).

Simplified version: don't include event count (would require the extraction function to return it). Just show track info and output path or error.

```
Extraction complete!

  [1] English (ASS) -> video.eng.ass
  [3] 中文 (SRT)     -> video.chi.ass

  2 tracks extracted successfully
```

**If --verbose:** Also print debug info before extraction: file size, duration, total tracks, codec details per selected track. After extraction: packet count, timing details if available.

Note on verbose: since the extraction pipeline doesn't currently expose packet counts, --verbose should at minimum print the track's codec ID, language code, and any other metadata from SubtitleTrack. More detailed extraction stats can be added later.

**Rewrite `cmd/mkv-sub-extractor/main.go`:**

Replace the entire contents with:
```go
package main

import (
    "os"
    "mkv-sub-extractor/pkg/cli"
)

func main() {
    os.Exit(cli.Run())
}
```

This is the minimal entry point — all logic lives in pkg/cli.
  </action>
  <verify>
Run `go build ./cmd/mkv-sub-extractor/` — must compile without errors. Run `go vet ./...` — no warnings across entire project.
  </verify>
  <done>
pkg/cli/run.go exists with Run() function implementing two-mode dispatch. runInteractive handles file picker -> MKV parse -> track select -> extract flow. runScriptable handles direct extraction with --track flag. Continue-on-failure extraction loop in ExtractWithProgress. Progress bar shown by default, suppressed by --quiet. Completion summary printed. main.go is a 4-line entry point calling cli.Run(). Entire project compiles and vets cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end human verification</name>
  <files>cmd/mkv-sub-extractor/main.go</files>
  <action>
Build the tool and verify all modes work end-to-end with real MKV files. This is a human verification checkpoint — no code changes, only testing.

Build: `go build -o mkv-sub-extractor.exe ./cmd/mkv-sub-extractor/`

**Test 1: Interactive mode (no arguments)**
1. Place 1+ MKV files with subtitles in a test directory
2. Run `./mkv-sub-extractor.exe` in that directory (no arguments)
3. Verify: Arrow-key file picker appears (even if only 1 file)
4. Select a file -> Verify: File info + track listing displayed
5. Verify: Image-based tracks shown as grayed out above selector
6. Multi-select tracks -> Verify: Progress bar during extraction
7. Verify: Completion summary shows extracted file paths
8. Verify: ASS files created in MKV's directory

**Test 2: Scriptable mode (--track flag)**
`./mkv-sub-extractor.exe video.mkv --track 1,2`
Verify: No interactive prompts, extracts tracks 1 and 2, shows progress + summary.

**Test 3: Quiet mode**
`./mkv-sub-extractor.exe video.mkv --track 1 --quiet`
Verify: Only the output file path is printed (no progress bar, no summary).

**Test 4: Output directory override**
`./mkv-sub-extractor.exe video.mkv --track 1 --output ./subs/`
Verify: ASS file created in ./subs/ directory.

**Test 5: Error cases**
- Non-existent file: `./mkv-sub-extractor.exe nonexistent.mkv` -> structured error, exit code 2
- Non-MKV file: `./mkv-sub-extractor.exe readme.txt` -> structured error, exit code 2
- No MKV files in dir: run from empty dir -> "No MKV files found" error
- Invalid track: `./mkv-sub-extractor.exe video.mkv --track 99` -> "Track not found" error, exit code 3

**Test 6: Help text**
`./mkv-sub-extractor.exe --help` -> Usage with examples
  </action>
  <verify>All 6 test scenarios pass as described above.</verify>
  <done>Tool works correctly in both interactive and scriptable modes. Error messages are structured and helpful. Progress bar and completion summary display properly.</done>
</task>

</tasks>

<verification>
- Complete tool builds: `go build ./cmd/mkv-sub-extractor/`
- Interactive mode: file picker -> track selector -> extraction -> completion summary
- Scriptable mode: --track flag skips all prompts, extracts specified tracks
- --quiet: only file paths on stdout
- --verbose: debug-level details
- --output: overrides output directory
- Error cases produce structured rustc-style errors with correct exit codes
- Multi-track extraction continues on failure
- Progress bar shown during extraction (suppressed by --quiet)
- Image tracks displayed as grayed-out context in interactive mode
</verification>

<success_criteria>
The tool works end-to-end in both interactive and scriptable modes. All four Phase 3 success criteria from the ROADMAP are met:
1. No-argument interactive mode produces ASS files via file picker + track selector
2. Scriptable mode (--track) extracts non-interactively
3. Default output path is MKV directory; --output overrides
4. Distinct structured error messages for non-MKV, not-found, no-subtitles, image-track cases
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-interface-and-error-handling/03-02-SUMMARY.md`
</output>
