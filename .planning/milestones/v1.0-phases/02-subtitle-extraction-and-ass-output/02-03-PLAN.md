---
phase: 02-subtitle-extraction-and-ass-output
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - pkg/assout/template.go
  - pkg/assout/srt_writer.go
  - pkg/assout/srt_writer_test.go
  - pkg/output/naming.go
  - pkg/output/naming_test.go
autonomous: true

must_haves:
  truths:
    - "SRT tracks produce valid ASS files with generated Script Info and V4+ Styles headers"
    - "Default style uses Microsoft YaHei font with white text, black outline, bottom-center alignment"
    - "SRT newlines are converted to \\N hard line breaks in ASS Dialogue text"
    - "Output files are named {video_basename}.{lang_code}.ass with collision handling"
  artifacts:
    - path: "pkg/assout/template.go"
      provides: "Default ASS header template for SRT-to-ASS conversion"
      contains: "Microsoft YaHei"
    - path: "pkg/assout/srt_writer.go"
      provides: "WriteSRTAsASS function for converting SRT events to ASS output"
      exports: ["WriteSRTAsASS"]
    - path: "pkg/output/naming.go"
      provides: "GenerateOutputPath function for output file naming with collision handling"
      exports: ["GenerateOutputPath"]
  key_links:
    - from: "pkg/assout/srt_writer.go"
      to: "pkg/assout/template.go"
      via: "WriteSRTAsASS writes the default header template before events"
      pattern: "defaultASSHeader"
    - from: "pkg/assout/srt_writer.go"
      to: "pkg/subtitle/srt.go"
      via: "Uses ConvertSRTTagsToASS for tag mapping in each event's text"
      pattern: "ConvertSRTTagsToASS"
    - from: "pkg/assout/srt_writer.go"
      to: "pkg/assout/timestamp.go"
      via: "Uses FormatASSTimestamp for Dialogue line timestamps"
      pattern: "FormatASSTimestamp"
    - from: "pkg/output/naming.go"
      to: "pkg/mkvinfo/types.go"
      via: "Uses SubtitleTrack.Language and SubtitleTrack.Name for filename generation"
      pattern: "SubtitleTrack"
---

<objective>
Implement the SRT-to-ASS conversion writer and the output file naming system. After this plan, the tool can convert SRT subtitle tracks to valid ASS format with a generated default style, and determine the correct output file path with language codes and collision handling.

Purpose: SRT (S_TEXT/UTF8) is the most common text subtitle format in MKV files. This plan provides the complete SRT conversion pipeline and the file naming logic shared by both extraction paths.

Output: `pkg/assout/` SRT writer with default template, `pkg/output/` naming logic.
</objective>

<execution_context>
@C:/Users/SOUL/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/SOUL/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-RESEARCH.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-01-SUMMARY.md
@pkg/mkvinfo/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement default ASS template and SRT-to-ASS writer</name>
  <files>pkg/assout/template.go, pkg/assout/srt_writer.go, pkg/assout/srt_writer_test.go</files>
  <action>
**Create `pkg/assout/template.go`:**

Define the default ASS header constant for SRT-to-ASS conversion. Per user decisions and discretion recommendations:

```go
// defaultASSHeader is the generated header for SRT-to-ASS conversion.
// Font: Microsoft YaHei (user decision), Size: 22 (discretion: middle of 20-24 range),
// PlayRes: 1920x1080 (discretion: modern standard), CRLF line endings (discretion: ASS convention).
const defaultASSHeader = "[Script Info]\r\n" +
    "; Script generated by mkv-sub-extractor\r\n" +
    "ScriptType: v4.00+\r\n" +
    "PlayResX: 1920\r\n" +
    "PlayResY: 1080\r\n" +
    "WrapStyle: 0\r\n" +
    "ScaledBorderAndShadow: yes\r\n" +
    "\r\n" +
    "[V4+ Styles]\r\n" +
    "Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, " +
    "OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, " +
    "ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, " +
    "Alignment, MarginL, MarginR, MarginV, Encoding\r\n" +
    "Style: Default,Microsoft YaHei,22," +
    "&H00FFFFFF,&H000000FF,&H00000000,&H80000000," +
    "0,0,0,0," +
    "100,100,0,0," +
    "1,2,1," +
    "2," +
    "10,10,10," +
    "1\r\n"
```

Style breakdown:
- PrimaryColour: &H00FFFFFF (white, fully opaque)
- SecondaryColour: &H000000FF (blue, for karaoke -- standard default)
- OutlineColour: &H00000000 (black outline)
- BackColour: &H80000000 (semi-transparent black shadow)
- Bold=0, Italic=0, Underline=0, StrikeOut=0
- ScaleX=100, ScaleY=100, Spacing=0, Angle=0
- BorderStyle=1 (outline+shadow), Outline=2, Shadow=1
- Alignment=2 (bottom-center, numpad style)
- MarginL=10, MarginR=10, MarginV=10
- Encoding=1 (default)

Also define the default events Format line:
```go
const defaultEventsFormat = "Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text\r\n"
```

**Create `pkg/assout/srt_writer.go`:**

Implement `WriteSRTAsASS(w io.Writer, events []SubtitleEvent) error`:

1. Write `defaultASSHeader` to writer
2. Write `\r\n[Events]\r\n`
3. Write `defaultEventsFormat`
4. Sort events by Start time (ascending)
5. For each event:
   - Apply `subtitle.ConvertSRTTagsToASS(event.Text)` to convert HTML tags
   - Replace `\n` with `\N` (ASS hard line break) and strip `\r`
   - Write Dialogue line:
     ```
     Dialogue: 0,{Start},{End},Default,,0,0,0,,{Text}\r\n
     ```
   - Layer is always 0 for SRT, Style is always "Default", Name/Margins/Effect are empty/zero

**Create `pkg/assout/srt_writer_test.go`:**

Test WriteSRTAsASS with:
- Two simple events -> output contains [Script Info], [V4+ Styles], [Events], and 2 Dialogue lines
- Events are sorted by timestamp in output regardless of input order
- Event text with SRT tags gets converted (verify `<i>` becomes `{\i1}`)
- Multi-line text with `\n` gets converted to `\N` in output
- Empty events list -> header only, [Events] section, Format line, no Dialogue lines
- Output starts with `[Script Info]` and contains "Microsoft YaHei"
- Output uses CRLF line endings throughout
- Dialogue lines use "Default" style and layer 0
  </action>
  <verify>Run `go test ./pkg/assout/... -v -run TestWriteSRTAsASS` -- all tests pass. Run `go vet ./pkg/assout/` -- clean.</verify>
  <done>WriteSRTAsASS produces valid ASS files from SRT events with default Microsoft YaHei style, correct tag conversion, newline handling, and CRLF line endings.</done>
</task>

<task type="auto">
  <name>Task 2: Implement output file naming with language codes and collision handling</name>
  <files>pkg/output/naming.go, pkg/output/naming_test.go</files>
  <action>
**Create `pkg/output/naming.go`:**

Implement `GenerateOutputPath(videoPath string, track mkvinfo.SubtitleTrack, existingPaths map[string]bool) string`:

Per user decision: `{video_basename}.{lang_code}.ass` with ISO 639-2 three-letter codes.

1. Extract directory and base name (strip extension) from `videoPath`
2. Get language code from `track.Language`. If empty or "und", use "und"
3. Generate candidate: `{dir}/{basename}.{lang}.ass`
4. If candidate is not in `existingPaths`, mark it and return
5. **Collision with track name:** If track has a non-empty `Name`, sanitize it (replace path-unsafe characters with underscore, trim, limit length to 50 chars) and try: `{dir}/{basename}.{lang}.{sanitized_name}.ass`
6. **Collision fallback with sequence number:** If still colliding, try `{dir}/{basename}.{lang}.2.ass`, `.3.ass`, etc. until a unique path is found
7. Always mark the returned path in `existingPaths` before returning

Also implement `sanitizeFileName(name string) string`:
- Replace characters not in `[a-zA-Z0-9_\-. ]` with underscore
- Collapse multiple underscores to one
- Trim leading/trailing underscores and spaces
- Limit to 50 characters
- If result is empty after sanitization, return "track"

**Create `pkg/output/naming_test.go`:**

Test GenerateOutputPath:
- Basic: `movie.mkv` + lang="eng" -> `movie.eng.ass`
- Undetermined language: lang="" -> `movie.und.ass`
- Undetermined language: lang="und" -> `movie.und.ass`
- Path with directory: `/path/to/movie.mkv` + lang="chi" -> `/path/to/movie.chi.ass`
- Collision with track name: Two tracks with lang="eng", first gets `movie.eng.ass`, second has Name="Commentary" -> `movie.eng.Commentary.ass`
- Collision fallback: Two tracks with lang="eng" and no Name -> first gets `movie.eng.ass`, second gets `movie.eng.2.ass`
- Triple collision: Three eng tracks, no names -> `.eng.ass`, `.eng.2.ass`, `.eng.3.ass`
- sanitizeFileName: special characters replaced, length limited, empty after sanitize returns "track"
  </action>
  <verify>Run `go test ./pkg/output/... -v` -- all tests pass. Run `go vet ./pkg/output/` -- clean.</verify>
  <done>GenerateOutputPath produces correct {basename}.{lang}.ass paths with ISO 639-2 codes, handles collisions using track name then sequence numbers, and sanitizes track names for filesystem safety.</done>
</task>

</tasks>

<verification>
```bash
go test ./pkg/assout/... ./pkg/output/... -v -count=1
go vet ./pkg/assout/... ./pkg/output/...
```
All tests pass. No vet warnings. SRT conversion path and output naming complete.
</verification>

<success_criteria>
- Default ASS header template uses Microsoft YaHei font, size 22, PlayRes 1920x1080, bottom-center alignment
- WriteSRTAsASS produces valid ASS files with sorted Dialogue lines and correct tag conversion
- SRT newlines converted to \N hard line breaks in ASS output
- GenerateOutputPath generates correct filenames with language codes
- Collision handling tries track name first, then sequence numbers
- CRLF line endings throughout ASS output
</success_criteria>

<output>
After completion, create `.planning/phases/02-subtitle-extraction-and-ass-output/02-03-SUMMARY.md`
</output>
