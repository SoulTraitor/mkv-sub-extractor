---
phase: 02-subtitle-extraction-and-ass-output
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - pkg/extract/extract.go
  - pkg/extract/extract_test.go
  - pkg/assout/writer.go
  - pkg/assout/writer_test.go
  - pkg/assout/ssa_convert.go
  - pkg/assout/ssa_convert_test.go
autonomous: true

must_haves:
  truths:
    - "Subtitle packets can be extracted from MKV by track number using matroska-go ReadPacket"
    - "ASS/SSA tracks produce valid ASS files with CodecPrivate header preserved verbatim"
    - "SSA V4 headers are converted to ASS V4+ format with correct field mapping"
    - "Dialogue lines are sorted by start timestamp in output, not MKV storage order"
    - "Missing EndTime (BlockDuration) is handled via gap-fill strategy"
  artifacts:
    - path: "pkg/extract/extract.go"
      provides: "ExtractSubtitlePackets function for MKV packet extraction by track number"
      exports: ["ExtractSubtitlePackets"]
    - path: "pkg/assout/writer.go"
      provides: "WriteASSPassthrough function combining CodecPrivate header with event Dialogue lines"
      exports: ["WriteASSPassthrough"]
    - path: "pkg/assout/ssa_convert.go"
      provides: "ConvertSSAHeaderToASS function for V4-to-V4+ header conversion"
      exports: ["ConvertSSAHeaderToASS"]
  key_links:
    - from: "pkg/extract/extract.go"
      to: "matroska-go ReadPacket"
      via: "Demuxer.ReadPacket() loop filtered by track number"
      pattern: "ReadPacket"
    - from: "pkg/assout/writer.go"
      to: "pkg/subtitle/types.go"
      via: "Accepts []SubtitleEvent sorted by Start time"
      pattern: "SubtitleEvent"
    - from: "pkg/assout/writer.go"
      to: "pkg/assout/timestamp.go"
      via: "Uses FormatASSTimestamp for Dialogue line timestamps"
      pattern: "FormatASSTimestamp"
    - from: "pkg/assout/writer.go"
      to: "pkg/assout/ssa_convert.go"
      via: "Calls ConvertSSAHeaderToASS when codec is S_TEXT/SSA"
      pattern: "ConvertSSAHeaderToASS"
---

<objective>
Implement the MKV packet extraction core and the ASS/SSA passthrough output path. After this plan, the tool can extract ASS and SSA subtitle tracks from MKV files and produce valid ASS output files with the original CodecPrivate header preserved verbatim (or converted from SSA V4 to ASS V4+).

Purpose: This is the primary extraction pipeline for ASS/SSA tracks -- the most common subtitle format in anime and foreign-language MKV files.

Output: `pkg/extract/` package for MKV packet reading, `pkg/assout/` writer and SSA converter.
</objective>

<execution_context>
@C:/Users/SOUL/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/SOUL/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-RESEARCH.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-01-SUMMARY.md
@pkg/mkvinfo/types.go
@pkg/mkvinfo/mkvinfo.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement MKV subtitle packet extraction and SSA V4->V4+ conversion</name>
  <files>pkg/extract/extract.go, pkg/extract/extract_test.go, pkg/assout/ssa_convert.go, pkg/assout/ssa_convert_test.go</files>
  <action>
**Create `pkg/extract/extract.go`:**

Implement `ExtractSubtitlePackets(demuxer *matroska.Demuxer, trackNumber uint8) ([]RawSubtitlePacket, error)`:

```go
// RawSubtitlePacket holds raw packet data from matroska-go before codec-specific parsing.
type RawSubtitlePacket struct {
    StartTime uint64 // nanoseconds
    EndTime   uint64 // nanoseconds (may be 0 if BlockDuration missing)
    Data      []byte // raw block data
}
```

- Loop `demuxer.ReadPacket()` until `io.EOF`
- Filter packets where `pkt.Track == trackNumber`
- Collect into `[]RawSubtitlePacket` with `StartTime`, `EndTime`, `Data` from the matroska-go `Packet`
- **Early verification of timestamp sanity:** After collecting the first packet, check if `StartTime` is an astronomical value (> 10^16, suggesting IEEE 754 bits). If so, log a warning. The research notes that StartTime/EndTime are likely correct nanoseconds (based on matroska-go example code), but this is a safety check per the STATE.md blocker concern.
- **Gap-fill for missing EndTime** (per user decision): After collecting all packets, sort by StartTime. Then iterate: if `pkt.EndTime <= pkt.StartTime`, set `pkt.EndTime = nextPkt.StartTime`. For the last packet with missing EndTime, set `EndTime = StartTime + 5_000_000_000` (5 seconds default).

Create `pkg/extract/extract_test.go`:
- Test that the function compiles and the RawSubtitlePacket type is accessible
- Test gap-fill logic with a helper function: given packets with missing EndTime, verify they get filled correctly. Extract the gap-fill logic into a separate exported function `ApplyGapFill(packets []RawSubtitlePacket)` so it can be unit-tested without needing a real demuxer.
- Test cases for ApplyGapFill:
  - All packets have valid EndTime -> no changes
  - Packet with EndTime=0 -> gets next packet's StartTime
  - Packet with EndTime==StartTime -> gets next packet's StartTime
  - Last packet with EndTime=0 -> gets StartTime + 5s
  - Single packet with EndTime=0 -> gets StartTime + 5s
  - Empty slice -> no panic

**Create `pkg/assout/ssa_convert.go`:**

Implement `ConvertSSAHeaderToASS(header string) string` for SSA V4 -> ASS V4+ conversion:

1. Replace `ScriptType: v4.00` with `ScriptType: v4.00+` (exact match only -- do NOT match `v4.00+`)
2. Replace `[V4 Styles]` with `[V4+ Styles]` (exact match only -- do NOT match `[V4+ Styles]`)
3. Parse and update the `Format:` line under the styles section:
   - Find the line starting with `Format:` after `[V4 Styles]`
   - SSA fields (18): Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, TertiaryColour, BackColour, Bold, Italic, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, AlphaLevel, Encoding
   - ASS fields (23): Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
   - Mapping: TertiaryColour -> OutlineColour, remove AlphaLevel, add Underline/StrikeOut/ScaleX/ScaleY/Spacing/Angle between Italic and BorderStyle
4. Update each `Style:` line to match the new format:
   - Parse fields by the old format order
   - Remap TertiaryColour value -> OutlineColour position
   - Insert defaults: Underline=0, StrikeOut=0, ScaleX=100, ScaleY=100, Spacing=0, Angle=0
   - Remove AlphaLevel value
5. Convert SSA alignment to ASS alignment (numpad): SSA 1->1, 2->2, 3->3, 5->7, 6->8, 7->9, 9->4, 10->5, 11->6
6. In `[Events]` section: replace `Marked` with `Layer` in Format line; in Dialogue lines, `Marked=N` becomes just `N` (the Layer value)
7. If header doesn't contain `[V4 Styles]` (already V4+), return unchanged

Create `pkg/assout/ssa_convert_test.go`:
- Test with a minimal SSA V4 header containing 1 style -> verify output is valid V4+ format
- Test ScriptType replacement (v4.00 -> v4.00+)
- Test section header replacement ([V4 Styles] -> [V4+ Styles])
- Test style field remapping (18 fields -> 23 fields with correct values)
- Test alignment conversion (SSA 2 -> ASS 2, SSA 5 -> ASS 7, SSA 9 -> ASS 4)
- Test Marked -> Layer in events section
- Test passthrough when header is already V4+ (no changes)
  </action>
  <verify>Run `go test ./pkg/extract/... ./pkg/assout/... -v` -- all tests pass. Run `go vet ./pkg/extract/ ./pkg/assout/` -- clean.</verify>
  <done>MKV packet extraction works with track filtering and gap-fill. SSA V4-to-ASS V4+ conversion handles ScriptType, section header, style field remapping (18->23), alignment conversion, and Marked->Layer replacement.</done>
</task>

<task type="auto">
  <name>Task 2: Implement ASS passthrough writer</name>
  <files>pkg/assout/writer.go, pkg/assout/writer_test.go</files>
  <action>
**Create `pkg/assout/writer.go`:**

Implement `WriteASSPassthrough(w io.Writer, codecPrivate []byte, codecID string, events []SubtitleEvent) error`:

1. **Handle SSA conversion:** If `codecID == "S_TEXT/SSA"`, convert the CodecPrivate header from V4 to V4+ using `ConvertSSAHeaderToASS()` before writing. If `codecID == "S_TEXT/ASS"`, use CodecPrivate verbatim.

2. **Write header:** Write the (possibly converted) CodecPrivate content to writer. Use CRLF line endings (per discretion recommendation in research).

3. **Handle [Events] section:**
   - Check if CodecPrivate already contains `[Events]` section (case-insensitive search for `[Events]`)
   - If it does, check if it contains a `Format:` line under [Events]. If yes, extract and use that Format line. If it has `[Events]` but no Format, add the default Format line.
   - If it does NOT contain `[Events]`, append `\r\n[Events]\r\n` and the default Format line: `Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text\r\n`

4. **Sort events** by StartTime (primary), then by ReadOrder (secondary, for stable ordering of events with identical timestamps).

5. **Write Dialogue lines:** For each event:
   ```
   Dialogue: {Layer},{Start},{End},{Style},{Name},{MarginL},{MarginR},{MarginV},{Effect},{Text}\r\n
   ```
   Where Start and End use `FormatASSTimestamp()` from timestamp.go.

6. **Clamp negative timestamps:** If Start or End would produce negative values (shouldn't happen with uint64, but be safe), clamp to 0.

**Create `pkg/assout/writer_test.go`:**

Test WriteASSPassthrough with:
- Simple CodecPrivate (Script Info + V4+ Styles, no [Events]) + 2 events -> valid ASS output with [Events] section appended
- CodecPrivate that already contains [Events] and Format line -> no duplicate section
- CodecPrivate that contains [Events] but no Format line -> Format line added
- Events sorted by timestamp in output regardless of input order
- SSA codec ID triggers V4->V4+ conversion on header
- ASS codec ID preserves header verbatim
- Empty events list -> header only, no Dialogue lines
- CRLF line endings in output
  </action>
  <verify>Run `go test ./pkg/assout/... -v` -- all tests pass. Run `go vet ./pkg/assout/` -- clean.</verify>
  <done>WriteASSPassthrough produces valid ASS files: CodecPrivate preserved verbatim for ASS tracks, converted for SSA tracks. [Events] section correctly handled (no duplicates). Dialogue lines sorted by timestamp with CRLF line endings.</done>
</task>

</tasks>

<verification>
```bash
go test ./pkg/extract/... ./pkg/assout/... -v -count=1
go vet ./pkg/extract/... ./pkg/assout/...
```
All tests pass. No vet warnings. ASS/SSA extraction pipeline complete.
</verification>

<success_criteria>
- ExtractSubtitlePackets reads packets filtered by track number from matroska-go demuxer
- Gap-fill strategy correctly handles missing BlockDuration (EndTime <= StartTime)
- ConvertSSAHeaderToASS transforms V4 headers to valid V4+ format (18->23 style fields)
- WriteASSPassthrough produces valid ASS files with verbatim CodecPrivate and sorted Dialogue lines
- CRLF line endings used throughout ASS output
</success_criteria>

<output>
After completion, create `.planning/phases/02-subtitle-extraction-and-ass-output/02-02-SUMMARY.md`
</output>
