---
phase: 01-mkv-parsing-and-track-discovery
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - pkg/mkvinfo/display.go
  - pkg/mkvinfo/display_test.go
  - cmd/mkv-sub-extractor/main.go
autonomous: false

must_haves:
  truths:
    - "Running the tool with an MKV file path prints file metadata header (name, size, duration, subtitle count)"
    - "Running the tool with an MKV file path lists all subtitle tracks in numbered list format with language, format type, track name, codec ID, and flags"
    - "Image subtitle tracks appear in the listing marked as not extractable (image subtitle)"
    - "An MKV with only image subtitles shows the track listing then prints the no-text-subtitles message in Chinese"
    - "Tool handles large MKV files without loading them into memory (streaming via io.ReadSeeker)"
    - "Non-MKV files and missing paths produce clear error messages"
  artifacts:
    - path: "pkg/mkvinfo/display.go"
      provides: "Track listing and file info display formatting"
      contains: "FormatTrackLine"
    - path: "cmd/mkv-sub-extractor/main.go"
      provides: "CLI entry point that parses a file argument and prints MKV info"
      contains: "func main"
  key_links:
    - from: "cmd/mkv-sub-extractor/main.go"
      to: "pkg/mkvinfo/mkvinfo.go"
      via: "mkvinfo.GetMKVInfo(path) call"
      pattern: "mkvinfo\\.GetMKVInfo"
    - from: "cmd/mkv-sub-extractor/main.go"
      to: "pkg/mkvinfo/display.go"
      via: "mkvinfo.FormatFileInfoHeader and mkvinfo.FormatTrackLine calls"
      pattern: "mkvinfo\\.Format(FileInfoHeader|TrackLine)"
    - from: "pkg/mkvinfo/display.go"
      to: "pkg/mkvinfo/types.go"
      via: "Uses FileInfo and SubtitleTrack types for formatting"
      pattern: "func Format.*\\(.*FileInfo|SubtitleTrack"
---

<objective>
Implement display formatting for track listings and file metadata, then wire everything together in a main.go entry point that accepts an MKV file path and prints the complete track listing.

Purpose: This completes the Phase 1 deliverable -- a user can run the tool with an MKV file and see all subtitle tracks with metadata. The display formatting implements the user's locked decisions about track listing format, non-text subtitle markers, and file metadata header.
Output: Working CLI binary that prints MKV file info and subtitle track listing.
</objective>

<execution_context>
@C:/Users/SOUL/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/SOUL/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-mkv-parsing-and-track-discovery/01-CONTEXT.md
@.planning/phases/01-mkv-parsing-and-track-discovery/01-RESEARCH.md
@.planning/phases/01-mkv-parsing-and-track-discovery/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement display formatting and main entry point</name>
  <files>
    pkg/mkvinfo/display.go
    pkg/mkvinfo/display_test.go
    cmd/mkv-sub-extractor/main.go
  </files>
  <action>
1. Create `pkg/mkvinfo/display.go` (package `mkvinfo`):

   Export function `FormatFileInfoHeader(info FileInfo) string` that returns a multi-line string matching this format (per user locked decision for file metadata display):
   ```
   File: {FileName}
   Size: {FormatFileSize(FileSize)} | Duration: {FormatDuration(Duration)} | Subtitle tracks: {SubtitleCount}
   ```
   - Use FormatFileSize and FormatDuration from format.go
   - SubtitleCount is the total (text + image)

   Export function `FormatTrackLine(t SubtitleTrack, showDefault bool) string` that returns a single line per track following the user's locked decision format:
   - For text subtitle tracks: `[{Index}] {LanguageName} ({FormatType}) {optional:"Name"} {CodecID} {optional:[default]} {optional:[forced]}`
   - For image subtitle tracks: `[{Index}] {LanguageName} ({FormatType}) {optional:"Name"} {CodecID} {optional:[default]} {optional:[forced]} -- not extractable (image subtitle)`

   Specific formatting rules from locked decisions:
   - Track name: Only show if non-empty, wrapped in double quotes (e.g. `"Commentary"`)
   - Codec ID: Always shown inline after format type (or after track name if present), e.g. `S_TEXT/UTF8`
   - Flags: `[default]` shown only if showDefault=true AND t.IsDefault=true. `[forced]` shown if t.IsForced=true.
   - Image marker: ` -- not extractable (image subtitle)` appended for non-text tracks
   - Use strings.Join or fmt.Sprintf to build the line. Parts should be space-separated.

   PITFALL - FlagDefault smart display: Per research pitfall #1, if ALL subtitle tracks have IsDefault=true (which is common due to Matroska spec defaults), showing [default] on every line is noisy. Implement a helper: `ShouldShowDefault(tracks []SubtitleTrack) bool` that returns true only if NOT all tracks have IsDefault=true (i.e., the flag provides meaningful differentiation).

   Export function `FormatTrackListing(info MKVInfo) string` that:
   - Calls FormatFileInfoHeader for the header
   - Adds a blank line
   - Determines whether to show [default] flags using ShouldShowDefault
   - For each track, calls FormatTrackLine (with showDefault based on ShouldShowDefault result)
   - If info.TextSubCount == 0 and info.SubtitleCount > 0: appends a blank line then "未找到可提取的文本字幕轨道" (per user locked decision)
   - If info.SubtitleCount == 0: appends "No subtitle tracks found in this file."
   - Returns the complete formatted string

2. Create `pkg/mkvinfo/display_test.go`:
   - Test FormatTrackLine with a text subtitle track (all fields populated): verify format matches `[1] English (SRT) "Commentary" S_TEXT/UTF8 [default]`
   - Test FormatTrackLine with an image subtitle track: verify it ends with `-- not extractable (image subtitle)`
   - Test FormatTrackLine with no track name: verify no empty quotes appear
   - Test FormatTrackLine with no flags: verify no [default] or [forced] tags
   - Test FormatFileInfoHeader: verify file name, formatted size, formatted duration, track count
   - Test FormatTrackListing with mixed text/image tracks
   - Test FormatTrackListing with only image tracks: verify Chinese message appears
   - Test ShouldShowDefault: all-true returns false, mixed returns true

3. Create `cmd/mkv-sub-extractor/main.go` (package `main`):
   - Minimal entry point for Phase 1 (full CLI is Phase 3)
   - Accept exactly one argument: the MKV file path (os.Args[1])
   - If no argument: print usage `Usage: mkv-sub-extractor <file.mkv>` and exit 1
   - Call `mkvinfo.GetMKVInfo(path)` -- on error, print error to stderr and exit 1
   - Call `mkvinfo.FormatTrackListing(result)` and print to stdout
   - Import the mkvinfo package as `"mkv-sub-extractor/pkg/mkvinfo"`

4. Verify the binary builds: `go build -o mkv-sub-extractor.exe ./cmd/mkv-sub-extractor/`
  </action>
  <verify>
Run `go test ./pkg/mkvinfo/ -v -run "TestFormat(Track|File|Listing)|TestShouldShow"` -- all display tests pass. Run `go build -o mkv-sub-extractor.exe ./cmd/mkv-sub-extractor/` -- binary compiles. Run `./mkv-sub-extractor.exe` with no args -- prints usage and exits 1. Run `./mkv-sub-extractor.exe nonexistent.mkv` -- prints error to stderr and exits 1.
  </verify>
  <done>
Display formatting matches user's locked decision format exactly. Binary compiles and handles error cases gracefully. FormatTrackListing produces complete output with file header, track lines, and appropriate messages for edge cases.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify track listing with real MKV file</name>
  <files>cmd/mkv-sub-extractor/main.go</files>
  <action>
CHECKPOINT: Human verification of the complete Phase 1 output.

What was built: Complete MKV parsing and track discovery implementation -- the tool accepts an MKV file path and prints file metadata followed by a numbered list of all subtitle tracks with language names, format types, codec IDs, flags, and image subtitle markers.

How to verify:
1. Build the binary:
   ```
   cd F:/go/workspace/mkv-sub-extractor
   go build -o mkv-sub-extractor.exe ./cmd/mkv-sub-extractor/
   ```

2. Run against an MKV file you have locally:
   ```
   ./mkv-sub-extractor.exe "path/to/your/movie.mkv"
   ```

3. Expected output format:
   ```
   File: movie.mkv
   Size: 8.2 GB | Duration: 2:15:30 | Subtitle tracks: 4

   [1] English (SRT) S_TEXT/UTF8 [default]
   [2] 中文 (ASS) "简体中文字幕" S_TEXT/ASS
   [3] 日本語 (ASS) S_TEXT/ASS [forced]
   [4] English (PGS) S_HDMV/PGS -- not extractable (image subtitle)
   ```

4. Verify:
   - File name, size (human-readable), duration (H:MM:SS), track count are shown
   - Each subtitle track shows: number, language name (human-readable), format type, optional track name in quotes, codec ID, optional flags
   - Image subtitle tracks are marked "not extractable (image subtitle)"
   - If you only have image subtitles, verify the Chinese message appears

5. Test error handling:
   - `./mkv-sub-extractor.exe nonexistent.mkv` -- should print error
   - `./mkv-sub-extractor.exe some-text-file.txt` -- should print "not a valid MKV file"
   - `./mkv-sub-extractor.exe` (no args) -- should print usage

6. If you have a large MKV (1+ GB), verify it opens quickly without high memory usage.

Resume signal: Type "approved" if the track listing looks correct, or describe any issues with formatting, missing data, or errors.
  </action>
  <verify>User confirms the track listing output matches expected format and all edge cases are handled.</verify>
  <done>User has approved that the tool correctly lists subtitle tracks from a real MKV file with proper formatting, metadata, and error handling.</done>
</task>

</tasks>

<verification>
1. `go test ./... -v` -- all tests pass (codec, language, format, display)
2. `go build -o mkv-sub-extractor.exe ./cmd/mkv-sub-extractor/` -- binary compiles
3. `go vet ./...` -- no issues
4. Binary prints correct track listing for real MKV files
5. Error cases (no args, bad path, non-MKV file) produce clear messages
6. Large MKV files open without excessive memory usage
</verification>

<success_criteria>
- User can run `mkv-sub-extractor path/to/file.mkv` and see formatted output matching the locked decision format
- File metadata header shows file name, human-readable size, duration, subtitle track count
- Track listing uses numbered format: [N] Language (Format) "Name" CodecID [flags]
- Image subtitle tracks are clearly marked as "not extractable (image subtitle)"
- Only-image-subtitles case prints "未找到可提取的文本字幕轨道"
- No crashes on edge cases (unknown codecs, missing language, zero duration)
- All automated tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-mkv-parsing-and-track-discovery/01-02-SUMMARY.md`
</output>
