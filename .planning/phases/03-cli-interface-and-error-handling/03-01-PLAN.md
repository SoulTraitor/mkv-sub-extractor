---
phase: 03-cli-interface-and-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/cli/errors.go
  - pkg/cli/flags.go
  - pkg/cli/interactive.go
  - go.mod
  - go.sum
autonomous: true
requirements:
  - CLI-01
  - CLI-02
  - CLI-03
  - CLI-04
  - CLI-06
  - ERRH-01
  - ERRH-02
  - ERRH-03
  - ERRH-04

must_haves:
  truths:
    - "Structured error types exist for file-not-found, non-MKV, no-subtitles, and image-subtitle cases with rustc-style formatting"
    - "Config struct parsed from pflag handles positional MKV path, --track, --output, --quiet, --verbose flags with short aliases"
    - "Interactive file picker scans current directory for MKV files and presents arrow-key Select menu via huh"
    - "Interactive track multi-select shows extractable tracks as selectable options and displays image tracks as grayed-out context above the selector"
    - "Validation rejects non-MKV files, nonexistent paths, and produces CLIError with appropriate exit codes"
  artifacts:
    - path: "pkg/cli/errors.go"
      provides: "CLIError type with categories, exit codes, and rustc-style Format() using lipgloss"
      contains: "CLIError"
    - path: "pkg/cli/flags.go"
      provides: "Config struct and ParseFlags() using pflag with positional arg, --track, --output, --quiet, --verbose"
      contains: "ParseFlags"
    - path: "pkg/cli/interactive.go"
      provides: "PickMKVFile() and SelectTracks() using charmbracelet/huh Select and MultiSelect"
      contains: "SelectTracks"
  key_links:
    - from: "pkg/cli/flags.go"
      to: "github.com/spf13/pflag"
      via: "pflag.IntSliceVarP, pflag.StringVarP, pflag.BoolVarP"
      pattern: "flag\\..*VarP"
    - from: "pkg/cli/interactive.go"
      to: "github.com/charmbracelet/huh"
      via: "huh.NewSelect, huh.NewMultiSelect"
      pattern: "huh\\.New(Multi)?Select"
    - from: "pkg/cli/interactive.go"
      to: "pkg/mkvinfo"
      via: "SubtitleTrack type for track options"
      pattern: "mkvinfo\\.SubtitleTrack"
    - from: "pkg/cli/errors.go"
      to: "github.com/charmbracelet/lipgloss"
      via: "lipgloss styles for colored error formatting"
      pattern: "lipgloss\\.NewStyle"
---

<objective>
Create the CLI foundation: structured error types with rustc-style formatting, flag parsing with pflag, input validation, and interactive prompts using charmbracelet/huh for file picking and track multi-selection.

Purpose: Establish all the building blocks that the orchestration layer (Plan 03-02) will wire together into the final CLI. Error types define how failures are communicated. Flags define the user's input contract. Interactive prompts provide the arrow-key UX for file and track selection.

Output: Three new files in pkg/cli/ plus updated go.mod/go.sum with new dependencies (pflag, huh, lipgloss, progressbar).
</objective>

<execution_context>
@C:/Users/SOUL/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/SOUL/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-interface-and-error-handling/03-RESEARCH.md
@.planning/phases/03-cli-interface-and-error-handling/03-CONTEXT.md
@pkg/mkvinfo/types.go
@pkg/extract/pipeline.go
@pkg/mkvinfo/display.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create structured error types and flag parsing</name>
  <files>pkg/cli/errors.go, pkg/cli/flags.go, go.mod, go.sum</files>
  <action>
**Install dependencies first:**
```bash
go get github.com/spf13/pflag@v1.0.5
go get github.com/charmbracelet/huh@v0.8.0
go get github.com/charmbracelet/lipgloss
go get github.com/schollz/progressbar/v3
```

**Create `pkg/cli/errors.go`:**

Define a `CLIError` struct with fields:
- `Code string` — error code like "E01", "E02", "E03", "E04"
- `Title string` — short title like "File Not Found"
- `Context string` — the relevant path or identifier
- `Detail string` — what happened (1 sentence)
- `Suggestion string` — how to fix it (optional, may be empty)
- `ExitCode int` — process exit code

Define `ErrorCategory` constants and a `Format() string` method that renders rustc-style output:
```
error[E02]: File Not Found
  --> video.mkv
   |
   = The file "video.mkv" does not exist or cannot be read.
   = Try: Check the file path and ensure the file exists.
```

Use lipgloss for coloring:
- Error title line: bold red (lipgloss Color "9")
- Arrow/pipe: blue (lipgloss Color "12")
- Suggestion: green (lipgloss Color "10")

Also implement `func (e *CLIError) Error() string` so CLIError satisfies the error interface (returns the Title).

Define factory functions for each error type:
- `ErrFileNotFound(path string) *CLIError` — exit code 2, code E01, suggests checking path
- `ErrNotMKVFile(path string) *CLIError` — exit code 2, code E02, suggests providing .mkv file
- `ErrCannotReadFile(path string, reason error) *CLIError` — exit code 2, code E03, shows underlying error
- `ErrNoSubtitleTracks(path string) *CLIError` — exit code 3, code E10, tells user file has no subtitle tracks
- `ErrNoExtractableTracks(path string) *CLIError` — exit code 3, code E11, tells user only image subtitles exist, suggests OCR tools like SubtitleEdit or PGS2SRT
- `ErrImageTrackSelected(trackIndex int, formatType string) *CLIError` — exit code 3, code E12, tells user track is image-based, suggests OCR tools
- `ErrTrackNotFound(trackNum int, path string) *CLIError` — exit code 3, code E13, suggests listing tracks with interactive mode
- `ErrExtractionFailed(trackIndex int, reason error) *CLIError` — exit code 4, code E20
- `ErrPartialFailure(succeeded int, failed int) *CLIError` — exit code 4, code E21, some tracks succeeded but others failed
- `ErrNoMKVFilesInDir(dir string) *CLIError` — exit code 2, code E04, no MKV files in current directory

Exit code scheme: 1=general, 2=file error, 3=track error, 4=extraction error (per user decision).

**Create `pkg/cli/flags.go`:**

Define `Config` struct:
```go
type Config struct {
    MKVPath      string
    TrackNumbers []int
    OutputDir    string
    Quiet        bool
    Verbose      bool
}
```

Define `ParseFlags() Config` function:
- Use `pflag.IntSliceVarP` for `--track`/`-t`
- Use `pflag.StringVarP` for `--output`/`-o`
- Use `pflag.BoolVarP` for `--quiet`/`-q`
- Use `pflag.BoolVarP` for `--verbose`/`-v`
- After `pflag.Parse()`, get positional arg from `pflag.Args()` — first arg is MKV path
- Set custom usage function with examples in help text

Define `ValidateConfig(cfg Config) *CLIError` function:
- If MKV path is provided:
  - Check file exists (ErrFileNotFound if not)
  - Check file has .mkv extension case-insensitively (ErrNotMKVFile if not)
  - Check file is readable / not a directory (ErrCannotReadFile if fails)
- If output dir is provided:
  - Check directory exists, create if not (standard os.MkdirAll behavior)
- If both --quiet and --verbose are set, return a general error
- Return nil if all validation passes

Note: `--track` validation (checking track numbers exist in the MKV) happens later after MKV parsing, not in ValidateConfig. ValidateConfig only checks things knowable before opening the MKV.
  </action>
  <verify>
Run `go build ./pkg/cli/...` — must compile without errors. Run `go vet ./pkg/cli/...` — no warnings.
  </verify>
  <done>
pkg/cli/errors.go exists with CLIError type implementing error interface, rustc-style Format() with lipgloss colors, and factory functions for all error categories. pkg/cli/flags.go exists with Config struct, ParseFlags(), and ValidateConfig(). All four new dependencies (pflag, huh, lipgloss, progressbar) are in go.mod. Code compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create interactive file picker and track multi-selector</name>
  <files>pkg/cli/interactive.go</files>
  <action>
**Create `pkg/cli/interactive.go`:**

**Function `PickMKVFile() (string, error)`:**
- Scan current working directory for MKV files using `filepath.Glob("*.mkv")` combined with `filepath.Glob("*.MKV")` — deduplicate results (on Windows these may overlap due to case-insensitive FS; use a map to deduplicate)
- If no MKV files found, return `ErrNoMKVFilesInDir(dir)` (get dir via `os.Getwd()`)
- Build `[]huh.Option[string]` from the file list
- Present a `huh.NewSelect[string]()` with title "Select an MKV file" and the options
- Per user decision: always present the selector even if only 1 file exists (no auto-skip)
- Return the selected path

**Function `SelectTracks(tracks []mkvinfo.SubtitleTrack) ([]mkvinfo.SubtitleTrack, error)`:**
- Separate tracks into `extractable` (IsExtractable=true) and `imageBased` (IsExtractable=false) slices
- If no extractable tracks exist, return `ErrNoExtractableTracks` (user sees structured error with OCR suggestion)
- Per user decision: Display image-based tracks as grayed-out context ABOVE the multi-select:
  ```
    Image-based tracks (not extractable):
      [3] English (PGS) S_HDMV/PGS -- use OCR tools like SubtitleEdit
  ```
  Use lipgloss `Faint(true)` style for this block. Print to stdout before running the huh form.
- Build `[]huh.Option[int]` from extractable tracks only. Option key = formatted label like `[1] English (ASS) "Track Name"`, value = track.Index
- Present `huh.NewMultiSelect[int]()` with title "Select subtitle tracks to extract" and the options
- Per user decision: always present selector even if only 1 extractable track
- Add validation: at least one track must be selected (reject empty selection)
- Map selected indices back to SubtitleTrack objects and return

**Function `formatTrackOption(t mkvinfo.SubtitleTrack) string`:**
- Format: `[{Index}] {LanguageName} ({FormatType})` with optional `"{Name}"` suffix if Name is non-empty
- Keep it concise for the menu — don't include codec ID or flags (those are for the detailed listing)

Import `github.com/charmbracelet/huh` and `github.com/charmbracelet/lipgloss` and `mkv-sub-extractor/pkg/mkvinfo`.
  </action>
  <verify>
Run `go build ./pkg/cli/...` — must compile without errors. Run `go vet ./pkg/cli/...` — no warnings.
  </verify>
  <done>
pkg/cli/interactive.go exists with PickMKVFile() using huh Select, SelectTracks() using huh MultiSelect with image tracks displayed as grayed-out context above the selector. formatTrackOption() provides concise labels. Code compiles cleanly with huh and lipgloss imports.
  </done>
</task>

</tasks>

<verification>
- `go build ./pkg/cli/...` compiles all three files without errors
- `go vet ./pkg/cli/...` produces no warnings
- go.mod contains all four new dependencies: spf13/pflag, charmbracelet/huh, charmbracelet/lipgloss, schollz/progressbar/v3
- CLIError.Format() produces multi-line rustc-style output (verifiable by inspection)
- ParseFlags() uses pflag with short aliases -t, -o, -q, -v
- ValidateConfig checks file existence, .mkv extension, and mutually exclusive quiet/verbose
- PickMKVFile() uses huh.NewSelect
- SelectTracks() uses huh.NewMultiSelect with validation rejecting empty selection
- Image tracks displayed with Faint lipgloss style above the multi-select
</verification>

<success_criteria>
All three pkg/cli/ files compile. Error types cover all ERRH requirements. Flags cover CLI-01, CLI-04, CLI-06. Interactive functions cover CLI-02, CLI-03. The pkg/cli package provides a complete API surface for the orchestration layer to consume in Plan 03-02.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-interface-and-error-handling/03-01-SUMMARY.md`
</output>
