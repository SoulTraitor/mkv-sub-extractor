---
phase: 02-subtitle-extraction-and-ass-output
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - pkg/subtitle/types.go
  - pkg/subtitle/ass.go
  - pkg/subtitle/ass_test.go
  - pkg/subtitle/srt.go
  - pkg/subtitle/srt_test.go
  - pkg/assout/timestamp.go
  - pkg/assout/timestamp_test.go
autonomous: true

must_haves:
  truths:
    - "ASS timestamp formatting converts nanoseconds to H:MM:SS.CC with proper centisecond rounding"
    - "ASS block data parsing correctly splits ReadOrder and remaining fields, handling commas in Text field"
    - "SRT HTML tags (b, i, u, font color) are converted to ASS override tags with correct syntax"
    - "Font color hex values are reversed from RGB to BGR order for ASS format"
  artifacts:
    - path: "pkg/subtitle/types.go"
      provides: "SubtitleEvent struct shared by all extraction paths"
      contains: "SubtitleEvent"
    - path: "pkg/assout/timestamp.go"
      provides: "FormatASSTimestamp function for nanosecond-to-centisecond conversion"
      exports: ["FormatASSTimestamp"]
    - path: "pkg/subtitle/ass.go"
      provides: "ParseASSBlockData function for Matroska ASS/SSA block data parsing"
      exports: ["ParseASSBlockData"]
    - path: "pkg/subtitle/srt.go"
      provides: "ConvertSRTTagsToASS function for HTML-to-ASS tag mapping"
      exports: ["ConvertSRTTagsToASS"]
  key_links:
    - from: "pkg/assout/timestamp.go"
      to: "pkg/subtitle/types.go"
      via: "FormatASSTimestamp takes nanosecond uint64 matching SubtitleEvent.Start/End fields"
      pattern: "FormatASSTimestamp"
    - from: "pkg/subtitle/ass.go"
      to: "pkg/subtitle/types.go"
      via: "ParseASSBlockData populates SubtitleEvent fields"
      pattern: "SubtitleEvent"
---

<objective>
Implement and test the core pure functions that form the foundation of subtitle extraction: ASS timestamp formatting, ASS/SSA block data parsing, and SRT HTML tag conversion. These are deterministic string transformations with clear input/output contracts -- ideal TDD candidates.

Purpose: These building blocks are consumed by the ASS passthrough writer (Plan 02) and SRT-to-ASS converter (Plan 03). Getting them right with comprehensive tests prevents bugs from propagating into the integration layer.

Output: Tested pure functions in `pkg/subtitle/` and `pkg/assout/` packages, ready for use by subsequent plans.
</objective>

<execution_context>
@C:/Users/SOUL/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/SOUL/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-RESEARCH.md
@pkg/mkvinfo/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define SubtitleEvent types and implement ASS timestamp formatting with TDD</name>
  <files>pkg/subtitle/types.go, pkg/assout/timestamp.go, pkg/assout/timestamp_test.go</files>
  <action>
**RED phase:**

Create `pkg/subtitle/types.go` with the shared `SubtitleEvent` struct:
```go
type SubtitleEvent struct {
    Start          uint64 // nanoseconds (from Packet.StartTime)
    End            uint64 // nanoseconds (from Packet.EndTime)
    Layer          int    // ASS layer number (from block data or 0 for SRT)
    Style          string // ASS style name (from block data or "Default" for SRT)
    Name           string // speaker name (from block data or empty)
    MarginL        string // margin override or "0"
    MarginR        string // margin override or "0"
    MarginV        string // margin override or "0"
    Effect         string // ASS effect or empty
    Text           string // dialogue text (ASS override tags or converted SRT text)
    ReadOrder      int    // ASS block ReadOrder (for stable sort; 0 for SRT)
}
```

Create `pkg/assout/timestamp_test.go` with test cases for `FormatASSTimestamp(ns uint64) string`:
- `0` -> `"0:00:00.00"` (zero)
- `1_000_000_000` -> `"0:00:01.00"` (1 second)
- `60_000_000_000` -> `"0:01:00.00"` (1 minute)
- `3_600_000_000_000` -> `"1:00:00.00"` (1 hour)
- `5_550_000_000` -> `"0:00:05.55"` (fractional seconds)
- `5_555_000_000` -> `"0:00:05.56"` (rounding up at 5ms: 555ms -> 55.5cs -> round to 56cs)
- `5_554_000_000` -> `"0:00:05.55"` (rounding down: 554ms -> 55.4cs -> round to 55cs)
- `3_723_450_000_000` -> `"1:02:03.45"` (all components)
- `36_000_000_000_000` -> `"10:00:00.00"` (10 hours, multi-digit hour)
- `5_000_000` -> `"0:00:00.01"` (exactly 5ms = 0.5cs -> rounds to 1cs -- rounding boundary)
- `4_999_999` -> `"0:00:00.00"` (just under 0.5cs -> rounds to 0)

Run tests -- they MUST fail (FormatASSTimestamp doesn't exist yet).

**GREEN phase:**

Create `pkg/assout/timestamp.go` implementing `FormatASSTimestamp`:
- Use integer arithmetic only (no float64): `cs := (ns + 5_000_000) / 10_000_000`
- Extract hours, minutes, seconds, centiseconds via integer division/modulo
- Format as `fmt.Sprintf("%d:%02d:%02d.%02d", h, m, s, cs)`
- Clamp: if ns could theoretically be 0, it's fine (already produces `0:00:00.00`)

Run tests -- all MUST pass.

**REFACTOR:** Clean up if needed, ensure tests still pass.
  </action>
  <verify>Run `go test ./pkg/assout/ -run TestFormatASSTimestamp -v` -- all test cases pass. Run `go vet ./pkg/assout/` and `go vet ./pkg/subtitle/` -- clean.</verify>
  <done>FormatASSTimestamp converts nanosecond uint64 values to "H:MM:SS.CC" ASS timestamp strings with correct centisecond rounding (not truncation). SubtitleEvent type is defined and compilable.</done>
</task>

<task type="auto">
  <name>Task 2: Implement ASS block data parsing and SRT tag conversion with TDD</name>
  <files>pkg/subtitle/ass.go, pkg/subtitle/ass_test.go, pkg/subtitle/srt.go, pkg/subtitle/srt_test.go</files>
  <action>
**RED phase -- ASS block data parsing:**

Create `pkg/subtitle/ass_test.go` with test cases for `ParseASSBlockData(data []byte) (readOrder int, layer int, remaining string, err error)`:

The block data format is: `ReadOrder,Layer,Style,Name,MarginL,MarginR,MarginV,Effect,Text`
- `"0,0,Default,,0,0,0,,Hello world"` -> readOrder=0, layer=0, remaining=`"Default,,0,0,0,,Hello world"`
- `"1,0,Default,,0,0,0,,Hello, world!"` -> readOrder=1, layer=0, remaining contains `"Hello, world!"` (comma in text preserved)
- `"42,1,Italic,,0,0,0,,Text with, many, commas"` -> readOrder=42, layer=1, remaining contains `"Text with, many, commas"`
- `"0,0,Default,,0,0,0,,"` -> readOrder=0, layer=0, remaining ends with empty text (valid)
- `"bad"` -> error (not enough fields)
- `"abc,0,Default,,0,0,0,,text"` -> error (non-numeric ReadOrder)
- `""` -> error (empty data)

**RED phase -- SRT tag conversion:**

Create `pkg/subtitle/srt_test.go` with test cases for `ConvertSRTTagsToASS(text string) string`:
- `"Hello world"` -> `"Hello world"` (no tags)
- `"<b>bold</b>"` -> `"{\b1}bold{\b0}"` (bold)
- `"<i>italic</i>"` -> `"{\i1}italic{\i0}"` (italic)
- `"<u>underline</u>"` -> `"{\u1}underline{\u0}"` (underline)
- `"<b><i>bold italic</i></b>"` -> `"{\b1}{\i1}bold italic{\i0}{\b0}"` (nested)
- `"<font color=\"#FF0000\">red</font>"` -> `"{\c&H0000FF&}red{\c}"` (RGB #FF0000 -> BGR 0000FF)
- `"<font color=\"#00FF00\">green</font>"` -> `"{\c&H00FF00&}green{\c}"` (RGB #00FF00 -> BGR 00FF00)
- `"<font color=\"#0000FF\">blue</font>"` -> `"{\c&HFF0000&}blue{\c}"` (RGB #0000FF -> BGR FF0000)
- `"<font color='#AABBCC'>test</font>"` -> `"{\c&HCCBBAA&}test{\c}"` (single quotes, BGR reversal)
- `"<B>UPPER</B>"` -> `"{\b1}UPPER{\b0}"` (case insensitive)
- `"<b>unclosed"` -> `"{\b1}unclosed"` (unclosed tag -- no auto-close per discretion)
- `"<unknown>text</unknown>"` -> `"text"` (unknown tags stripped)
- `"plain <i>mixed</i> plain"` -> `"plain {\i1}mixed{\i0} plain"` (mixed content)
- Named colors: `"<font color=\"red\">text</font>"` -> convert `red` to `{\c&H0000FF&}` (support basic named colors: red=#FF0000, blue=#0000FF, green=#008000, yellow=#FFFF00, white=#FFFFFF, cyan=#00FFFF, magenta=#FF00FF)

Run tests -- they MUST fail.

**GREEN phase:**

Implement `ParseASSBlockData` in `pkg/subtitle/ass.go`:
- Use `strings.SplitN(string(data), ",", 9)` to split into at most 9 parts
- Parse ReadOrder from parts[0] via `strconv.Atoi`
- Parse Layer from parts[1] via `strconv.Atoi`
- Remaining = `strings.Join(parts[2:], ",")` which gives `Style,Name,MarginL,MarginR,MarginV,Effect,Text`
- Return error if fewer than 9 parts or non-numeric ReadOrder/Layer

Implement `ConvertSRTTagsToASS` in `pkg/subtitle/srt.go`:
- Case-insensitive replacements: use `regexp.MustCompile(`(?i)<b>`)` etc. for opening/closing tags
- Font color regex: `(?i)<font\s+color=["']#([0-9a-fA-F]{6})["']>` -> extract hex, reverse RGB to BGR, format as `{\c&HBBGGRR&}`
- Named color support: small map of color name -> hex (red->#FF0000, blue->#0000FF, green->#008000, yellow->#FFFF00, white->#FFFFFF, cyan->#00FFFF, magenta->#FF00FF). Use regex `(?i)<font\s+color=["'](\w+)["']>` for named colors, look up in map, convert to BGR.
- Strip remaining unrecognized HTML tags with `<[^>]*>` regex
- Compile all regexes at package level (not per-call) for performance

Run tests -- all MUST pass.

**REFACTOR:** Ensure regex patterns are compiled once at package level via `var ... = regexp.MustCompile(...)`. Clean up, tests still pass.
  </action>
  <verify>Run `go test ./pkg/subtitle/ -v` -- all test cases pass for both ParseASSBlockData and ConvertSRTTagsToASS. Run `go vet ./pkg/subtitle/` -- clean.</verify>
  <done>ParseASSBlockData correctly splits Matroska ASS block data into ReadOrder, Layer, and remaining fields (handling commas in Text). ConvertSRTTagsToASS maps b/i/u/font-color HTML tags to ASS override tags with correct BGR color reversal and case insensitivity, strips unknown tags.</done>
</task>

</tasks>

<verification>
```bash
go test ./pkg/subtitle/... ./pkg/assout/... -v
go vet ./pkg/subtitle/... ./pkg/assout/...
```
All tests pass. No vet warnings. Pure functions ready for integration.
</verification>

<success_criteria>
- FormatASSTimestamp produces correct H:MM:SS.CC strings with centisecond rounding for all edge cases
- ParseASSBlockData handles the 9-field comma-separated format including commas in the Text field
- ConvertSRTTagsToASS correctly maps all 4 SRT tag types to ASS override tags
- Font color RGB-to-BGR reversal is correct
- All tests pass with `go test -v`
</success_criteria>

<output>
After completion, create `.planning/phases/02-subtitle-extraction-and-ass-output/02-01-SUMMARY.md`
</output>
