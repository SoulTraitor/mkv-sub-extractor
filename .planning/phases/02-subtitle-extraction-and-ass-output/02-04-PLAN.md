---
phase: 02-subtitle-extraction-and-ass-output
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - pkg/extract/pipeline.go
  - pkg/extract/pipeline_test.go
autonomous: false

must_haves:
  truths:
    - "A single function call extracts a subtitle track from an MKV file and writes a valid ASS output file"
    - "SRT tracks are automatically converted to ASS format with generated headers"
    - "ASS/SSA tracks use passthrough mode preserving original styles from CodecPrivate"
    - "Output ASS files render correctly when loaded in a media player"
  artifacts:
    - path: "pkg/extract/pipeline.go"
      provides: "ExtractTrackToASS public API that orchestrates the full extraction pipeline"
      exports: ["ExtractTrackToASS"]
  key_links:
    - from: "pkg/extract/pipeline.go"
      to: "pkg/extract/extract.go"
      via: "Calls ExtractSubtitlePackets to get raw packets from MKV"
      pattern: "ExtractSubtitlePackets"
    - from: "pkg/extract/pipeline.go"
      to: "pkg/assout/writer.go"
      via: "Calls WriteASSPassthrough for ASS/SSA codec tracks"
      pattern: "WriteASSPassthrough"
    - from: "pkg/extract/pipeline.go"
      to: "pkg/assout/srt_writer.go"
      via: "Calls WriteSRTAsASS for SRT codec tracks"
      pattern: "WriteSRTAsASS"
    - from: "pkg/extract/pipeline.go"
      to: "pkg/subtitle/ass.go"
      via: "Calls ParseASSBlockData to convert raw packets to SubtitleEvents for ASS/SSA tracks"
      pattern: "ParseASSBlockData"
    - from: "pkg/extract/pipeline.go"
      to: "pkg/output/naming.go"
      via: "Calls GenerateOutputPath for output file naming"
      pattern: "GenerateOutputPath"
---

<objective>
Create the public integration API that ties together all Phase 2 components (extraction, parsing, writing, naming) into a single function call, then verify the complete pipeline works with real MKV files.

Purpose: This is the culmination of Phase 2 -- the function that Phase 3 (CLI) will call when the user selects a subtitle track. Without this integration layer, the individual packages can't be used together.

Output: `pkg/extract/pipeline.go` with `ExtractTrackToASS` function, verified with real MKV files.
</objective>

<execution_context>
@C:/Users/SOUL/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/SOUL/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-RESEARCH.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-01-SUMMARY.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-02-SUMMARY.md
@.planning/phases/02-subtitle-extraction-and-ass-output/02-03-SUMMARY.md
@pkg/mkvinfo/types.go
@pkg/mkvinfo/mkvinfo.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extraction pipeline integrating all Phase 2 packages</name>
  <files>pkg/extract/pipeline.go, pkg/extract/pipeline_test.go</files>
  <action>
**Create `pkg/extract/pipeline.go`:**

Implement `ExtractTrackToASS(mkvPath string, track mkvinfo.SubtitleTrack, outputDir string) (outputPath string, err error)`:

This is the public API that Phase 3 (CLI) will call. It orchestrates the full pipeline:

1. **Open MKV file and create demuxer:**
   ```go
   file, err := os.Open(mkvPath)
   demuxer, err := matroska.NewDemuxer(file)
   ```

2. **Get track info for CodecPrivate:**
   - Iterate demuxer tracks to find the one matching `track.Number`
   - Extract `trackInfo.CodecPrivate` (the raw header bytes)
   - This is needed for ASS/SSA passthrough mode

3. **Extract raw packets:**
   ```go
   packets, err := ExtractSubtitlePackets(demuxer, track.Number)
   ```

4. **Apply gap-fill** for missing EndTime:
   ```go
   ApplyGapFill(packets)
   ```

5. **Convert raw packets to SubtitleEvents based on codec:**

   For **ASS/SSA** tracks (`track.CodecID == "S_TEXT/ASS"` or `"S_TEXT/SSA"`):
   - For each packet, call `subtitle.ParseASSBlockData(pkt.Data)` to get ReadOrder, Layer, and remaining fields (Style, Name, MarginL, MarginR, MarginV, Effect, Text)
   - Create SubtitleEvent with Start/End from packet, Layer from parsed data, and the remaining fields split into their respective SubtitleEvent fields
   - Parse the remaining string to extract Style, Name, MarginL, MarginR, MarginV, Effect, Text (split into at most 7 parts on comma to get these fields -- Style through Text where Text can contain commas)

   For **SRT** tracks (`track.CodecID == "S_TEXT/UTF8"`):
   - For each packet, create SubtitleEvent with Start/End from packet, Text from `string(pkt.Data)`, Layer=0, Style="Default", empty Name/Margins/Effect

6. **Determine output path:**
   ```go
   existingPaths := make(map[string]bool)
   // If outputDir is empty, use the directory of mkvPath
   if outputDir == "" {
       outputDir = filepath.Dir(mkvPath)
   }
   videoForNaming := filepath.Join(outputDir, filepath.Base(mkvPath))
   outputPath = output.GenerateOutputPath(videoForNaming, track, existingPaths)
   ```

7. **Write ASS output:**
   - Create output file
   - For ASS/SSA: call `assout.WriteASSPassthrough(file, codecPrivate, track.CodecID, events)`
   - For SRT: call `assout.WriteSRTAsASS(file, events)`

8. **Return** the output path and nil error on success

Also implement a batch-aware variant or consider: if extracting multiple tracks from the same MKV, the existingPaths map should be shared to handle naming collisions. For now, `ExtractTrackToASS` handles single-track extraction. Add `ExtractTracksToASS(mkvPath string, tracks []mkvinfo.SubtitleTrack, outputDir string) ([]string, error)` that extracts multiple tracks with shared collision tracking:
- Opens the MKV file once
- Extracts each track's packets in sequence (ReadPacket loops through the entire file once per track -- matroska-go requires sequential reading)
- Shares the `existingPaths` map across all tracks for correct naming collision handling
- Returns slice of output paths

**Create `pkg/extract/pipeline_test.go`:**

Test the pipeline with compilation checks:
- Verify ExtractTrackToASS function signature is correct and callable
- Verify ExtractTracksToASS function signature is correct
- Test error handling: non-existent file path returns error
- Test error handling: invalid MKV file returns error
  </action>
  <verify>Run `go test ./pkg/extract/... -v` -- compilation tests pass. Run `go build ./...` -- entire project compiles. Run `go vet ./...` -- clean.</verify>
  <done>ExtractTrackToASS and ExtractTracksToASS provide the complete public API for subtitle extraction. The pipeline correctly routes ASS/SSA tracks through passthrough mode and SRT tracks through conversion mode.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify extracted ASS files with real MKV files</name>
  <files>cmd/mkv-sub-extractor/main.go</files>
  <action>
Temporarily update main.go to add extraction capability: after listing tracks, call `extract.ExtractTrackToASS()` on the first extractable text subtitle track to produce an ASS output file. This is a temporary integration test -- Phase 3 will implement proper CLI track selection.

What was built: Complete subtitle extraction pipeline -- MKV packet extraction, ASS passthrough with CodecPrivate preservation, SRT-to-ASS conversion with default style and tag mapping, output file naming with language codes. All pure functions tested. Integration API ready.

How to verify:
1. Build the project: `go build -o mkv-sub-extractor.exe ./cmd/mkv-sub-extractor/`
2. Test with an MKV file containing ASS subtitles -- check output .ass file has [Script Info], [V4+ Styles], [Events] sections with correct timestamps. Open in mpv/VLC to verify correct rendering.
3. Test with an MKV file containing SRT subtitles -- check output has generated headers with "Microsoft YaHei" font, Dialogue lines use "Default" style, and formatting tags are correctly converted.
4. Verify output file naming: `{video}.{lang}.ass` with correct language code.
5. Compare subtitle timestamps against video playback -- should be accurate within ~100ms.
  </action>
  <verify>Build succeeds. Output ASS files open in text editor without errors. ASS files render correctly in mpv or VLC with proper timing.</verify>
  <done>Output ASS files render correctly in a media player. Timestamps are accurate. ASS tracks preserve original styles. SRT tracks display with default Microsoft YaHei style at bottom-center.</done>
</task>

</tasks>

<verification>
```bash
go build ./...
go test ./... -v -count=1
go vet ./...
```
All packages compile. All tests pass. Human verification confirms correct rendering in media player.
</verification>

<success_criteria>
- ExtractTrackToASS produces valid ASS files from both ASS/SSA and SRT tracks in real MKV files
- ASS tracks preserve original styles from CodecPrivate
- SRT tracks get proper generated headers with Microsoft YaHei default style
- Timestamps are accurate -- subtitles appear at correct moments during playback
- Output files render correctly in mpv or VLC
- File naming follows {basename}.{lang}.ass convention
</success_criteria>

<output>
After completion, create `.planning/phases/02-subtitle-extraction-and-ass-output/02-04-SUMMARY.md`
</output>
